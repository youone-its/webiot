<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Control System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 1.4em;
        }

        .icon {
            font-size: 1.8em;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-recording {
            background: #fff3cd;
            color: #856404;
            animation: pulse 1.5s infinite;
        }

        .status-listening {
            background: #d1ecf1;
            color: #0c5460;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        /* AC Control Specific Styles */
        .ac-display {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        .ac-status {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .ac-temp {
            font-size: 4em;
            font-weight: 700;
            margin: 10px 0;
        }

        .ac-temp-unit {
            font-size: 0.5em;
            opacity: 0.8;
        }

        .ac-status.off {
            opacity: 0.5;
        }

        .ac-temp.off {
            opacity: 0.3;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .control-btn {
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .control-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-power {
            background: #e74c3c;
            grid-column: span 3;
        }

        .btn-power.on {
            background: #27ae60;
        }

        .btn-temp-down {
            background: #3498db;
        }

        .btn-temp-up {
            background: #e67e22;
        }

        .door-control {
            background: linear-gradient(135deg, #8e44ad 0%, #c0392b 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }

        .door-status {
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .door-icon {
            font-size: 5em;
            margin: 20px 0;
        }

        .sensor-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .sensor-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .sensor-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .sensor-value {
            font-size: 2em;
            font-weight: 700;
            color: #333;
        }

        .sensor-unit {
            font-size: 0.8em;
            color: #999;
        }

        .pattern-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .pattern-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }

        .pattern-knocks {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .knock-dot {
            width: 30px;
            height: 30px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: 600;
        }

        .access-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .log-granted {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .log-denied {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .log-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .log-time {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .countdown {
            font-size: 3em;
            font-weight: 700;
            text-align: center;
            color: #667eea;
            margin: 20px 0;
        }

        .info-box {
            background: #e7f3ff;
            border: 2px solid #b3d9ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .info-box p {
            margin: 5px 0;
            color: #004085;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Smart Home Control System</h1>
            <p>AC Control, Door Security & Environmental Monitoring</p>
        </div>

        <div class="grid">
            <!-- Connection Status Card -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üîå</span>
                    <h2>Connection</h2>
                </div>
                
                <div class="status-badge status-offline" id="mqttStatus">Disconnected</div>
                <div class="status-badge status-offline" id="espStatus">ESP32 Offline</div>

                <div class="config-section">
                    <div class="form-group">
                        <label>Broker WebSocket</label>
                        <input type="text" id="broker" value="ws://10.4.67.183" placeholder="ws://broker:port">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="username" value="kelasc">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="password" value="kelasc">
                    </div>
                </div>

                <button class="btn btn-primary" id="connectBtn" onclick="connectMQTT()">Connect to Broker</button>
                <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectMQTT()" disabled>Disconnect</button>
            </div>

            <!-- AC Unit 1 -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">‚ùÑÔ∏è</span>
                    <h2>AC Unit 1</h2>
                </div>

                <div class="ac-display" id="ac1Display">
                    <div class="ac-status off" id="ac1Status">OFF</div>
                    <div class="ac-temp off" id="ac1Temp">
                        24<span class="ac-temp-unit">¬∞C</span>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="control-btn btn-power" id="ac1Power" onclick="toggleAC(1)" disabled>
                        <span id="ac1PowerText">‚ö° POWER</span>
                    </button>
                    <button class="control-btn btn-temp-down" onclick="tempDown(1)" disabled id="ac1TempDown">
                        ‚ùÑÔ∏è -
                    </button>
                    <button class="control-btn" style="background:#95a5a6;cursor:default;" disabled>
                        TEMP
                    </button>
                    <button class="control-btn btn-temp-up" onclick="tempUp(1)" disabled id="ac1TempUp">
                        üî• +
                    </button>
                </div>
            </div>

            <!-- AC Unit 2 -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">‚ùÑÔ∏è</span>
                    <h2>AC Unit 2</h2>
                </div>

                <div class="ac-display" id="ac2Display">
                    <div class="ac-status off" id="ac2Status">OFF</div>
                    <div class="ac-temp off" id="ac2Temp">
                        24<span class="ac-temp-unit">¬∞C</span>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="control-btn btn-power" id="ac2Power" onclick="toggleAC(2)" disabled>
                        <span id="ac2PowerText">‚ö° POWER</span>
                    </button>
                    <button class="control-btn btn-temp-down" onclick="tempDown(2)" disabled id="ac2TempDown">
                        ‚ùÑÔ∏è -
                    </button>
                    <button class="control-btn" style="background:#95a5a6;cursor:default;" disabled>
                        TEMP
                    </button>
                    <button class="control-btn btn-temp-up" onclick="tempUp(2)" disabled id="ac2TempUp">
                        üî• +
                    </button>
                </div>
            </div>

            <!-- Door Control -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üö™</span>
                    <h2>Door Control</h2>
                </div>

                <div class="door-control">
                    <div class="door-status" id="doorStatus">LOCKED</div>
                    <div class="door-icon" id="doorIcon">üîí</div>
                    <button class="control-btn btn-power" onclick="openDoor()" disabled id="doorBtn">
                        üîì OPEN DOOR
                    </button>
                </div>
            </div>

            <!-- Knock Pattern Control Card -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üëä</span>
                    <h2>Knock Pattern</h2>
                </div>

                <div class="status-badge status-offline" id="modeStatus">Idle</div>

                <div id="countdownDisplay" style="display:none;">
                    <div class="countdown" id="countdown">3</div>
                    <p style="text-align:center; color:#666; font-weight:600;">Knock your pattern now!</p>
                </div>

                <button class="btn btn-warning" id="recordBtn" onclick="recordPattern()" disabled>
                    üéôÔ∏è Record New Pattern
                </button>
                <button class="btn btn-success" id="listenBtn" onclick="startListening()" disabled>
                    üëÇ Start Listening Mode
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopListening()" disabled>
                    ‚èπÔ∏è Stop Listening
                </button>

                <div class="pattern-display" id="patternDisplay" style="display:none;">
                    <div class="pattern-title">Saved Pattern:</div>
                    <div class="pattern-knocks" id="patternKnocks"></div>
                    <p style="margin-top:10px; font-size:0.9em; color:#666;">
                        <span id="patternCount">0</span> knocks recorded
                    </p>
                </div>

                <div class="info-box">
                    <p><strong>How to use:</strong></p>
                    <p>1. Click "Record New Pattern"</p>
                    <p>2. Knock your secret pattern within 3 seconds</p>
                    <p>3. Click "Start Listening Mode"</p>
                    <p>4. Knock the same pattern to unlock</p>
                </div>
            </div>

            <!-- Temperature & Humidity Card -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üå°Ô∏è</span>
                    <h2>Environment Monitor</h2>
                </div>

                <div class="sensor-display">
                    <div class="sensor-item">
                        <div class="sensor-label">Temperature</div>
                        <div class="sensor-value">
                            <span id="temperature">--</span>
                            <span class="sensor-unit">¬∞C</span>
                        </div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-label">Humidity</div>
                        <div class="sensor-value">
                            <span id="humidity">--</span>
                            <span class="sensor-unit">%</span>
                        </div>
                    </div>
                </div>

                <p style="margin-top:15px; color:#666; font-size:0.9em; text-align:center;">
                    Last update: <span id="lastUpdate">Never</span>
                </p>
            </div>

            <!-- Access Log Card -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üìã</span>
                    <h2>System Log</h2>
                </div>

                <div class="access-log" id="accessLog">
                    <div class="log-entry log-info">
                        <div>System initialized</div>
                        <div class="log-time">Waiting for events...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        let client = null;
        let isConnected = false;
        let countdownInterval = null;

        // AC State (will be synced with ESP32)
        let ac1 = { power: false, temp: 24 };
        let ac2 = { power: false, temp: 24 };

        function updateMQTTStatus(connected) {
            const statusEl = document.getElementById('mqttStatus');
            if (connected) {
                statusEl.textContent = '‚úÖ Connected to Broker';
                statusEl.className = 'status-badge status-online';
            } else {
                statusEl.textContent = '‚ùå Disconnected';
                statusEl.className = 'status-badge status-offline';
            }
        }

        function updateESPStatus(online) {
            const statusEl = document.getElementById('espStatus');
            if (online) {
                statusEl.textContent = '‚úÖ ESP32 Online';
                statusEl.className = 'status-badge status-online';
                
                // Enable all control buttons
                enableAllControls();
            } else {
                statusEl.textContent = '‚ùå ESP32 Offline';
                statusEl.className = 'status-badge status-offline';
                
                // Disable all control buttons except connect
                disableAllControls();
            }
        }

        function enableAllControls() {
            document.getElementById('ac1Power').disabled = false;
            document.getElementById('ac2Power').disabled = false;
            document.getElementById('doorBtn').disabled = false;
            document.getElementById('recordBtn').disabled = false;
            
            // Enable temp controls if AC is on
            if (ac1.power) {
                document.getElementById('ac1TempDown').disabled = false;
                document.getElementById('ac1TempUp').disabled = false;
            }
            if (ac2.power) {
                document.getElementById('ac2TempDown').disabled = false;
                document.getElementById('ac2TempUp').disabled = false;
            }
        }

        function disableAllControls() {
            document.getElementById('ac1Power').disabled = true;
            document.getElementById('ac1TempDown').disabled = true;
            document.getElementById('ac1TempUp').disabled = true;
            document.getElementById('ac2Power').disabled = true;
            document.getElementById('ac2TempDown').disabled = true;
            document.getElementById('ac2TempUp').disabled = true;
            document.getElementById('doorBtn').disabled = true;
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('listenBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
        }

        function updateModeStatus(mode) {
            const statusEl = document.getElementById('modeStatus');
            const modes = {
                'idle': { text: '‚ö™ Idle', class: 'status-offline' },
                'recording': { text: 'üî¥ Recording Pattern...', class: 'status-recording' },
                'pattern_saved': { text: '‚úÖ Pattern Saved', class: 'status-online' },
                'listening': { text: 'üëÇ Listening for Knocks...', class: 'status-listening' }
            };
            
            const modeData = modes[mode] || modes['idle'];
            statusEl.textContent = modeData.text;
            statusEl.className = 'status-badge ' + modeData.class;
        }

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('accessLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const time = new Date().toLocaleTimeString('id-ID');
            entry.innerHTML = `
                <div>${message}</div>
                <div class="log-time">${time}</div>
            `;
            
            logDiv.insertBefore(entry, logDiv.firstChild);
            
            while (logDiv.children.length > 15) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function updateACDisplay(unit) {
            const ac = unit === 1 ? ac1 : ac2;
            const statusEl = document.getElementById(`ac${unit}Status`);
            const tempEl = document.getElementById(`ac${unit}Temp`);
            const powerBtn = document.getElementById(`ac${unit}Power`);
            const tempDownBtn = document.getElementById(`ac${unit}TempDown`);
            const tempUpBtn = document.getElementById(`ac${unit}TempUp`);
            
            if (ac.power) {
                statusEl.textContent = 'ON';
                statusEl.className = 'ac-status';
                tempEl.className = 'ac-temp';
                tempEl.innerHTML = `${ac.temp}<span class="ac-temp-unit">¬∞C</span>`;
                powerBtn.className = 'control-btn btn-power on';
                tempDownBtn.disabled = ac.temp <= 16;
                tempUpBtn.disabled = ac.temp >= 30;
            } else {
                statusEl.textContent = 'OFF';
                statusEl.className = 'ac-status off';
                tempEl.className = 'ac-temp off';
                tempEl.innerHTML = `${ac.temp}<span class="ac-temp-unit">¬∞C</span>`;
                powerBtn.className = 'control-btn btn-power';
                tempDownBtn.disabled = true;
                tempUpBtn.disabled = true;
            }
        }

        function toggleAC(unit) {
            if (!client || !isConnected) {
                alert('Not connected to broker!');
                return;
            }
            
            const ac = unit === 1 ? ac1 : ac2;
            ac.power = !ac.power;
            
            // If turning on, set to last temperature (or 24 default)
            if (ac.power && ac.temp === 0) {
                ac.temp = 24;
            }
            
            const command = {
                unit: unit,
                action: ac.power ? 'power_on' : 'power_off',
                temp: ac.temp
            };
            
            const message = new Paho.MQTT.Message(JSON.stringify(command));
            message.destinationName = 'c/5027241027/rumah/ac/command';
            client.send(message);
            
            updateACDisplay(unit);
            addLog(`AC ${unit} ${ac.power ? 'turned ON' : 'turned OFF'}`, ac.power ? 'granted' : 'info');
        }

        function tempUp(unit) {
            if (!client || !isConnected) return;
            
            const ac = unit === 1 ? ac1 : ac2;
            if (!ac.power) return;
            if (ac.temp >= 30) return;
            
            ac.temp++;
            
            const command = {
                unit: unit,
                action: 'temp_up',
                temp: ac.temp
            };
            
            const message = new Paho.MQTT.Message(JSON.stringify(command));
            message.destinationName = 'c/5027241027/rumah/ac/command';
            client.send(message);
            
            updateACDisplay(unit);
            addLog(`AC ${unit} temperature increased to ${ac.temp}¬∞C`, 'info');
        }

        function tempDown(unit) {
            if (!client || !isConnected) return;
            
            const ac = unit === 1 ? ac1 : ac2;
            if (!ac.power) return;
            if (ac.temp <= 16) return;
            
            ac.temp--;
            
            const command = {
                unit: unit,
                action: 'temp_down',
                temp: ac.temp
            };
            
            const message = new Paho.MQTT.Message(JSON.stringify(command));
            message.destinationName = 'c/5027241027/rumah/ac/command';
            client.send(message);
            
            updateACDisplay(unit);
            addLog(`AC ${unit} temperature decreased to ${ac.temp}¬∞C`, 'info');
        }

        function openDoor() {
            if (!client || !isConnected) {
                alert('Not connected to broker!');
                return;
            }
            
            const doorIcon = document.getElementById('doorIcon');
            const doorStatus = document.getElementById('doorStatus');
            const doorBtn = document.getElementById('doorBtn');
            
            // Open door
            doorIcon.textContent = 'üîì';
            doorStatus.textContent = 'UNLOCKED';
            doorBtn.disabled = true;
            
            const command = { action: 'open' };
            const message = new Paho.MQTT.Message(JSON.stringify(command));
            message.destinationName = 'c/5027241027/rumah/door/command';
            client.send(message);
            
            addLog('Door opened manually', 'granted');
            
            // Auto close after 2 seconds
            setTimeout(() => {
                doorIcon.textContent = 'üîí';
                doorStatus.textContent = 'LOCKED';
                if (isConnected) {
                    doorBtn.disabled = false;
                }
                
                const closeCommand = { action: 'close' };
                const closeMessage = new Paho.MQTT.Message(JSON.stringify(closeCommand));
                closeMessage.destinationName = 'c/5027241027/rumah/door/command';
                client.send(closeMessage);
                
                addLog('Door auto-locked', 'info');
            }, 2000);
        }

        function connectMQTT() {
            const broker = document.getElementById('broker').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!broker) {
                alert('Please enter broker address!');
                return;
            }

            addLog('Connecting to MQTT broker...', 'info');

            try {
                const url = new URL(broker);
                const host = url.hostname;
                const port = parseInt(url.port) || 9001;
                const path = url.pathname || '/mqtt';
                const clientId = 'web_' + Math.random().toString(16).substr(2, 8);

                client = new Paho.MQTT.Client(host, port, path, clientId);
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;

                const options = {
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    userName: username,
                    password: password,
                    useSSL: url.protocol === 'wss:'
                };

                client.connect(options);
            } catch (error) {
                addLog('Connection error: ' + error.message, 'denied');
                updateMQTTStatus(false);
            }
        }

        function onConnect() {
            isConnected = true;
            updateMQTTStatus(true);
            addLog('Connected to MQTT broker', 'granted');
            
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;

            // Subscribe to topics
            client.subscribe('rumah/status');
            client.subscribe('rumah/suhu');
            client.subscribe('rumah/knock');
            client.subscribe('rumah/ac/status');
            client.subscribe('rumah/door/status');
            
            addLog('Subscribed to all topics', 'info');
            
            // Request current AC state from ESP32
            const syncMsg = new Paho.MQTT.Message('SYNC');
            syncMsg.destinationName = 'c/5027241027/rumah/ac/command';
            client.send(syncMsg);
        }

        function onFailure(error) {
            updateMQTTStatus(false);
            addLog('Connection failed: ' + error.errorMessage, 'denied');
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                isConnected = false;
                updateMQTTStatus(false);
                updateESPStatus(false);
                addLog('Connection lost: ' + responseObject.errorMessage, 'denied');
                
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                disableAllControls();
            }
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            
            console.log('Message received:', topic, payload);
            
            try {
                const data = JSON.parse(payload);
                
                if (topic === 'rumah/status') {
                    handleStatusMessage(data);
                } else if (topic === 'rumah/suhu') {
                    handleTemperatureMessage(data);
                } else if (topic === 'rumah/knock') {
                    handleKnockMessage(data);
                } else if (topic === 'rumah/ac/status') {
                    handleACStatus(data);
                } else if (topic === 'rumah/door/status') {
                    handleDoorStatus(data);
                }
            } catch (e) {
                console.error('Error parsing message:', e);
            }
        }

        function handleStatusMessage(data) {
            if (data.status === 'online') {
                updateESPStatus(true);
                addLog('ESP32 connected', 'granted');
            }
            
            if (data.mode) {
                updateModeStatus(data.mode);
                
                if (data.mode === 'recording') {
                    showCountdown();
                } else if (data.mode === 'pattern_saved') {
                    hideCountdown();
                    document.getElementById('listenBtn').disabled = false;
                    addLog('Pattern saved successfully', 'granted');
                } else if (data.mode === 'listening') {
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('listenBtn').disabled = true;
                }
            }
        }

        function handleTemperatureMessage(data) {
            document.getElementById('temperature').textContent = data.temperature.toFixed(1);
            document.getElementById('humidity').textContent = data.humidity.toFixed(1);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('id-ID');
        }

        function handleKnockMessage(data) {
            if (data.pattern) {
                const patternDiv = document.getElementById('patternDisplay');
                const knocksDiv = document.getElementById('patternKnocks');
                knocksDiv.innerHTML = '';
                
                for (let i = 0; i < data.count; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'knock-dot';
                    dot.textContent = i + 1;
                    knocksDiv.appendChild(dot);
                }
                
                document.getElementById('patternCount').textContent = data.count;
                patternDiv.style.display = 'block';
            }
            
            if (data.matched !== undefined) {
                if (data.matched && data.action === 'open_door') {
                    addLog('‚úÖ Pattern matched! Door access GRANTED', 'granted');
                    // Simulate door opening
                    document.getElementById('doorIcon').textContent = 'üîì';
                    document.getElementById('doorStatus').textContent = 'UNLOCKED';
                    setTimeout(() => {
                        document.getElementById('doorIcon').textContent = 'üîí';
                        document.getElementById('doorStatus').textContent = 'LOCKED';
                    }, 2000);
                } else if (!data.matched && data.action === 'deny_access') {
                    addLog('‚ùå Pattern mismatch! Door access DENIED', 'denied');
                }
            }
        }

        function handleACStatus(data) {
            // Sync AC state from ESP32
            if (data.unit === 1) {
                ac1.power = data.power;
                ac1.temp = data.temp;
                updateACDisplay(1);
            } else if (data.unit === 2) {
                ac2.power = data.power;
                ac2.temp = data.temp;
                updateACDisplay(2);
            }
        }

        function handleDoorStatus(data) {
            const doorIcon = document.getElementById('doorIcon');
            const doorStatus = document.getElementById('doorStatus');
            
            if (data.status === 'open') {
                doorIcon.textContent = 'üîì';
                doorStatus.textContent = 'UNLOCKED';
            } else {
                doorIcon.textContent = 'üîí';
                doorStatus.textContent = 'LOCKED';
            }
        }

        function showCountdown() {
            document.getElementById('countdownDisplay').style.display = 'block';
            let count = 3;
            document.getElementById('countdown').textContent = count;
            
            countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    document.getElementById('countdown').textContent = count;
                } else {
                    hideCountdown();
                }
            }, 1000);
        }

        function hideCountdown() {
            document.getElementById('countdownDisplay').style.display = 'none';
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function disconnectMQTT() {
            if (client && isConnected) {
                client.disconnect();
                isConnected = false;
                updateMQTTStatus(false);
                updateESPStatus(false);
                addLog('Disconnected by user', 'info');
                
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                disableAllControls();
            }
        }

        function recordPattern() {
            if (!client || !isConnected) {
                alert('Not connected to broker!');
                return;
            }
            
            const message = new Paho.MQTT.Message('RECORD_PATTERN');
            message.destinationName = 'c/5027241027/rumah/command';
            client.send(message);
            
            addLog('Recording pattern command sent', 'info');
        }

        function startListening() {
            if (!client || !isConnected) {
                alert('Not connected to broker!');
                return;
            }
            
            const message = new Paho.MQTT.Message('START_LISTENING');
            message.destinationName = 'c/5027241027/rumah/command';
            client.send(message);
            
            addLog('Listening mode activated', 'info');
        }

        function stopListening() {
            if (!client || !isConnected) {
                alert('Not connected to broker!');
                return;
            }
            
            const message = new Paho.MQTT.Message('STOP_LISTENING');
            message.destinationName = 'c/5027241027/rumah/command';
            client.send(message);
            
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('listenBtn').disabled = false;
            updateModeStatus('idle');
            
            addLog('Listening mode stopped', 'info');
        }

        // Initialize AC displays
        updateACDisplay(1);
        updateACDisplay(2);
    </script>
</body>
</html>