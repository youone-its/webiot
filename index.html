<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Smart Home Control System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 1.4em;
        }

        .icon {
            font-size: 1.8em;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-checking {
            background: #fff3cd;
            color: #856404;
            animation: pulse 1.5s infinite;
        }

        .status-recording {
            background: #fff3cd;
            color: #856404;
            animation: pulse 1.5s infinite;
        }

        .status-listening {
            background: #d1ecf1;
            color: #0c5460;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .ac-display {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        .ac-status {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .ac-temp {
            font-size: 4em;
            font-weight: 700;
            margin: 10px 0;
        }

        .ac-temp-unit {
            font-size: 0.5em;
            opacity: 0.8;
        }

        .ac-status.off {
            opacity: 0.5;
        }

        .ac-temp.off {
            opacity: 0.3;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .control-btn {
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .control-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-power {
            background: #e74c3c;
            grid-column: span 3;
        }

        .btn-power.on {
            background: #27ae60;
        }

        .btn-temp-down {
            background: #3498db;
        }

        .btn-temp-up {
            background: #e67e22;
        }

        .door-control {
            background: linear-gradient(135deg, #8e44ad 0%, #c0392b 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }

        .door-status {
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .door-icon {
            font-size: 5em;
            margin: 20px 0;
        }

        .access-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .log-granted {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .log-denied {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .log-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .log-time {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .info-box {
            background: #e7f3ff;
            border: 2px solid #b3d9ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .info-box p {
            margin: 5px 0;
            color: #004085;
            font-size: 0.9em;
        }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .warning-box p {
            margin: 5px 0;
            color: #856404;
            font-size: 0.9em;
        }

        .connection-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .info-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Smart Home Control System</h1>
            <p>ESP32 MQTT Control with Real-time Updates</p>
        </div>

        <div class="grid">
            <!-- Connection Status Card -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üîå</span>
                    <h2>MQTT Connection</h2>
                </div>

                <div class="status-badge status-offline" id="espStatus">‚ö†Ô∏è Not Connected</div>

                <div class="warning-box">
                    <p><strong>‚ÑπÔ∏è MQTT Connection</strong></p>
                    <p>Click "Connect to MQTT" to establish connection with broker.</p>
                    <p>ESP32 harus sudah terhubung ke MQTT broker yang sama!</p>
                </div>

                <div class="config-section">
                    <div class="form-group">
                        <label>MQTT Broker WebSocket URL</label>
                        <input type="text" id="brokerUrl" value="ws://10.4.67.183:9001" placeholder="ws://broker-ip:9001">
                    </div>
                    <div class="form-group">
                        <label>Username (optional)</label>
                        <input type="text" id="mqttUsername" placeholder="Leave empty if no auth">
                    </div>
                    <div class="form-group">
                        <label>Password (optional)</label>
                        <input type="password" id="mqttPassword" placeholder="Leave empty if no auth">
                    </div>
                </div>

                <button class="btn btn-success" onclick="connectMQTT()" id="connectBtn">üîå Connect to MQTT</button>
                <button class="btn btn-danger" onclick="disconnectMQTT()" id="disconnectBtn" disabled>üîå Disconnect</button>

                <div class="connection-info">
                    <div class="info-item">
                        <div class="info-label">MQTT Status</div>
                        <div class="info-value" id="mqttStatus">Disconnected</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ESP32 Status</div>
                        <div class="info-value" id="esp32Status">Unknown</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Last Update</div>
                        <div class="info-value" id="lastCheck">Never</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Commands Sent</div>
                        <div class="info-value" id="cmdCount">0</div>
                    </div>
                </div>

                <div class="info-box">
                    <p><strong>üì° MQTT Topics:</strong></p>
                    <p style="font-family: monospace; font-size: 0.8em;">
                        AC1 ‚Üí Set in AC Unit 1 card<br>
                        AC2 ‚Üí Set in AC Unit 2 card<br>
                        Door ‚Üí Set in Door Control card<br>
                        Knock ‚Üí Set in Knock Pattern card
                    </p>
                    <p style="margin-top: 10px;"><strong>Subscribe topics (status):</strong></p>
                    <p style="font-family: monospace; font-size: 0.8em;">
                        ESP32 Status: c/5027241027/rumah/status
                    </p>
                </div>
            </div>

            <!-- AC Unit 1 -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">‚ùÑÔ∏è</span>
                    <h2>AC Unit 1</h2>
                </div>

                <div class="config-section" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label>MQTT Topic</label>
                        <input type="text" id="ac1Topic" value="c/5027241027/rumah/ac/command" placeholder="Enter AC1 topic">
                    </div>
                </div>

                <div class="ac-display" id="ac1Display">
                    <div class="ac-status off" id="ac1Status">OFF</div>
                    <div class="ac-temp off" id="ac1Temp">
                        24<span class="ac-temp-unit">¬∞C</span>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="control-btn btn-power" id="ac1Power" onclick="toggleAC(1)" disabled>
                        <span id="ac1PowerText">‚ö° POWER</span>
                    </button>
                    <button class="control-btn btn-temp-down" onclick="tempDown(1)" id="ac1TempDown" disabled>
                        ‚ùÑÔ∏è -
                    </button>
                    <button class="control-btn" style="background:#95a5a6;cursor:default;" disabled>
                        TEMP
                    </button>
                    <button class="control-btn btn-temp-up" onclick="tempUp(1)" id="ac1TempUp" disabled>
                        üî• +
                    </button>
                </div>
            </div>

            <!-- AC Unit 2 -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">‚ùÑÔ∏è</span>
                    <h2>AC Unit 2</h2>
                </div>

                <div class="config-section" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label>MQTT Topic</label>
                        <input type="text" id="ac2Topic" value="c/5027241027/rumah/ac/command" placeholder="Enter AC2 topic">
                    </div>
                </div>

                <div class="ac-display" id="ac2Display">
                    <div class="ac-status off" id="ac2Status">OFF</div>
                    <div class="ac-temp off" id="ac2Temp">
                        24<span class="ac-temp-unit">¬∞C</span>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="control-btn btn-power" id="ac2Power" onclick="toggleAC(2)" disabled>
                        <span id="ac2PowerText">‚ö° POWER</span>
                    </button>
                    <button class="control-btn btn-temp-down" onclick="tempDown(2)" id="ac2TempDown" disabled>
                        ‚ùÑÔ∏è -
                    </button>
                    <button class="control-btn" style="background:#95a5a6;cursor:default;" disabled>
                        TEMP
                    </button>
                    <button class="control-btn btn-temp-up" onclick="tempUp(2)" id="ac2TempUp" disabled>
                        üî• +
                    </button>
                </div>
            </div>

            <!-- Door Control -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üö™</span>
                    <h2>Door Control</h2>
                </div>

                <div class="config-section" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label>MQTT Topic</label>
                        <input type="text" id="doorTopic" value="c/5027241027/rumah/door/command" placeholder="Enter Door topic">
                    </div>
                </div>

                <div class="door-control">
                    <div class="door-status" id="doorStatus">LOCKED</div>
                    <div class="door-icon" id="doorIcon">üîí</div>
                    <button class="control-btn btn-power" onclick="openDoor()" disabled id="doorBtn">
                        üîì OPEN DOOR
                    </button>
                </div>
            </div>

            <!-- Knock Pattern Control Card -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üëä</span>
                    <h2>Knock Pattern</h2>
                </div>

                <div class="config-section" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label>MQTT Topic</label>
                        <input type="text" id="knockTopic" value="c/5027241027/rumah/command" placeholder="Enter Knock topic">
                    </div>
                </div>

                <div class="status-badge status-offline" id="modeStatus">Ready</div>

                <button class="btn btn-warning" id="recordBtn" onclick="recordPattern()" disabled>
                    üéôÔ∏è Record New Pattern
                </button>
                <button class="btn btn-success" id="listenBtn" onclick="startListening()" disabled>
                    üëÇ Start Listening Mode
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopListening()" disabled>
                    ‚èπÔ∏è Stop Listening
                </button>

                <div class="info-box">
                    <p><strong>How to use:</strong></p>
                    <p>1. Connect to MQTT broker first</p>
                    <p>2. Click "Record New Pattern"</p>
                    <p>3. Knock your pattern on piezo sensor</p>
                    <p>4. Click "Start Listening Mode"</p>
                    <p>5. Knock to unlock door</p>
                </div>
            </div>

            <!-- System Log Card -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üìã</span>
                    <h2>System Log</h2>
                </div>

                <div class="access-log" id="accessLog">
                    <div class="log-entry log-info">
                        <div>System initialized - Ready to connect</div>
                        <div class="log-time">Waiting for MQTT connection...</div>
                    </div>
                </div>

                <div class="info-box" style="margin-top: 15px;">
                    <p><strong>üí° Setup Instructions:</strong></p>
                    <p>1. <strong>Mosquitto WebSocket Setup:</strong></p>
                    <p style="font-family: monospace; font-size: 0.85em; margin-left: 15px;">
                        # mosquitto.conf<br>
                        listener 1883<br>
                        protocol mqtt<br>
                        allow_anonymous true<br>
                        <br>
                        listener 9001<br>
                        protocol websockets<br>
                        allow_anonymous true
                    </p>
                    <p>2. Run: <code>mosquitto -c mosquitto.conf -v</code></p>
                    <p>3. If using auth, add username/password above</p>
                    <p>4. ESP32 must publish to /status topic</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MQTT.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>

    <script>
        // MQTT Configuration
        let mqttClient = null;
        let mqttConnected = false;
        
        // AC State (local tracking)
        let ac1 = { power: false, temp: 24 };
        let ac2 = { power: false, temp: 24 };
        let espOnline = false;
        let commandCount = 0;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('accessLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const time = new Date().toLocaleTimeString('id-ID');
            entry.innerHTML = `
                <div>${message}</div>
                <div class="log-time">${time}</div>
            `;
            
            logDiv.insertBefore(entry, logDiv.firstChild);
            
            while (logDiv.children.length > 15) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // MQTT Connection Functions
        function connectMQTT() {
            const brokerUrl = document.getElementById('brokerUrl').value;
            const username = document.getElementById('mqttUsername').value;
            const password = document.getElementById('mqttPassword').value;
            
            if (!brokerUrl || !brokerUrl.startsWith('ws://')) {
                alert('Masukkan MQTT Broker WebSocket URL yang valid!\nContoh: ws://10.4.67.183:9001');
                return;
            }

            try {
                addLog('üîå Connecting to MQTT broker...', 'info');
                document.getElementById('connectBtn').disabled = true;
                
                const options = {
                    clientId: 'smart_home_web_' + Math.random().toString(16).substr(2, 8),
                    clean: true,
                    connectTimeout: 4000,
                    reconnectPeriod: 1000
                };
                
                // Add credentials if provided
                if (username) {
                    options.username = username;
                    addLog('Using username: ' + username, 'info');
                }
                if (password) {
                    options.password = password;
                    addLog('Password provided', 'info');
                }
                
                mqttClient = mqtt.connect(brokerUrl, options);

                mqttClient.on('connect', function() {
                    mqttConnected = true;
                    reconnectAttempts = 0;
                    addLog('‚úÖ Connected to MQTT broker', 'granted');
                    updateMQTTStatus(true);
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('mqttStatus').textContent = 'Connected';
                    
                    // Subscribe to all ESP32 topics
                    mqttClient.subscribe('c/5027241027/rumah/status', (err) => {
                        if (!err) addLog('üì• Subscribed to status', 'info');
                    });
                    mqttClient.subscribe('c/5027241027/rumah/ac/status', (err) => {
                        if (!err) addLog('üì• Subscribed to AC status', 'info');
                    });
                    mqttClient.subscribe('c/5027241027/rumah/door/status', (err) => {
                        if (!err) addLog('üì• Subscribed to door status', 'info');
                    });
                    mqttClient.subscribe('c/5027241027/rumah/knock', (err) => {
                        if (!err) addLog('üì• Subscribed to knock status', 'info');
                    });
                    mqttClient.subscribe('c/5027241027/rumah/suhu', (err) => {
                        if (!err) addLog('üì• Subscribed to temperature', 'info');
                    });
                });

                mqttClient.on('message', function(topic, message) {
                    handleMQTTMessage(topic, message.toString());
                });

                mqttClient.on('error', function(error) {
                    addLog('‚ùå MQTT Error: ' + error.message, 'denied');
                    updateMQTTStatus(false);
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('mqttStatus').textContent = 'Error';
                });

                mqttClient.on('close', function() {
                    mqttConnected = false;
                    addLog('‚ö†Ô∏è MQTT connection closed', 'denied');
                    updateMQTTStatus(false);
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('mqttStatus').textContent = 'Disconnected';
                });

                mqttClient.on('offline', function() {
                    mqttConnected = false;
                    addLog('‚ö†Ô∏è MQTT broker offline', 'denied');
                    updateMQTTStatus(false);
                    document.getElementById('mqttStatus').textContent = 'Offline';
                });

                mqttClient.on('reconnect', function() {
                    reconnectAttempts++;
                    if (reconnectAttempts <= MAX_RECONNECT_ATTEMPTS) {
                        addLog(`üîÑ Reconnecting... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`, 'info');
                        document.getElementById('mqttStatus').textContent = 'Reconnecting...';
                    }
                });

            } catch (error) {
                addLog('‚ùå Failed to connect: ' + error.message, 'denied');
                updateMQTTStatus(false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('mqttStatus').textContent = 'Failed';
            }
        }

        function disconnectMQTT() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
                mqttConnected = false;
                updateMQTTStatus(false);
                addLog('üîå Disconnected from MQTT broker', 'info');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('mqttStatus').textContent = 'Disconnected';
            }
        }

        function updateMQTTStatus(connected) {
            mqttConnected = connected;
            const statusEl = document.getElementById('espStatus');
            
            if (connected) {
                statusEl.textContent = '‚úÖ MQTT Connected - Waiting for ESP32';
                statusEl.className = 'status-badge status-online';
            } else {
                statusEl.textContent = '‚ùå MQTT Disconnected';
                statusEl.className = 'status-badge status-offline';
                espOnline = false;
                disableAllControls();
                document.getElementById('esp32Status').textContent = 'Unknown';
            }
            
            document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString('id-ID');
        }

        function handleMQTTMessage(topic, message) {
            addLog(`üì© ${topic.split('/').pop()}`, 'info');
            
            try {
                const payload = JSON.parse(message);
                
                // ESP32 Status - {"status":"online"}
                if (topic === 'c/5027241027/rumah/status') {
                    if (payload.status === 'online') {
                        updateESPStatus(true, 'ESP32 online');
                        document.getElementById('esp32Status').textContent = 'Online';
                    } else if (payload.mode) {
                        // Knock mode status
                        const modeStatus = document.getElementById('modeStatus');
                        if (payload.mode === 'recording') {
                            modeStatus.textContent = 'üî¥ Recording...';
                            modeStatus.className = 'status-badge status-recording';
                            addLog('üéôÔ∏è ESP32 recording pattern', 'info');
                        } else if (payload.mode === 'listening') {
                            modeStatus.textContent = 'üëÇ Listening...';
                            modeStatus.className = 'status-badge status-listening';
                            document.getElementById('stopBtn').disabled = false;
                            document.getElementById('listenBtn').disabled = true;
                            addLog('üëÇ ESP32 listening for knocks', 'info');
                        } else if (payload.mode === 'idle' || payload.mode === 'pattern_saved') {
                            modeStatus.textContent = 'Ready';
                            modeStatus.className = 'status-badge status-offline';
                            document.getElementById('stopBtn').disabled = true;
                            if (espOnline) document.getElementById('listenBtn').disabled = false;
                            if (payload.mode === 'pattern_saved') {
                                addLog('‚úÖ Pattern saved successfully', 'granted');
                            }
                        }
                    }
                }
                
                // AC Status - {"unit":1,"power":true,"temp":24}
                else if (topic === 'c/5027241027/rumah/ac/status') {
                    if (payload.unit === 1) {
                        ac1.power = payload.power;
                        ac1.temp = payload.temp;
                        updateACDisplay(1);
                        addLog(`AC 1: ${payload.power ? 'ON' : 'OFF'} ${payload.temp}¬∞C`, 'info');
                    } else if (payload.unit === 2) {
                        ac2.power = payload.power;
                        ac2.temp = payload.temp;
                        updateACDisplay(2);
                        addLog(`AC 2: ${payload.power ? 'ON' : 'OFF'} ${payload.temp}¬∞C`, 'info');
                    }
                }
                
                // Door Status - {"status":"open"} or {"status":"closed"}
                else if (topic === 'c/5027241027/rumah/door/status') {
                    const doorIcon = document.getElementById('doorIcon');
                    const doorStatus = document.getElementById('doorStatus');
                    
                    if (payload.status === 'open') {
                        doorIcon.textContent = 'üîì';
                        doorStatus.textContent = 'UNLOCKED';
                        addLog('üö™ Door opened', 'granted');
                    } else if (payload.status === 'closed') {
                        doorIcon.textContent = 'üîí';
                        doorStatus.textContent = 'LOCKED';
                        addLog('üö™ Door locked', 'info');
                    }
                }
                
                // Knock Pattern - {"matched":true/false,"action":"..."}
                else if (topic === 'c/5027241027/rumah/knock') {
                    if (payload.matched !== undefined) {
                        if (payload.matched) {
                            addLog('‚úÖ Knock pattern MATCHED!', 'granted');
                        } else {
                            addLog('‚ùå Knock pattern FAILED', 'denied');
                        }
                    } else if (payload.pattern) {
                        addLog(`‚úÖ Pattern recorded: ${payload.count} knocks`, 'granted');
                    } else if (payload.error) {
                        addLog(`‚ùå Recording error: ${payload.error}`, 'denied');
                    }
                }
                
                // Temperature/Humidity - {"temperature":24.8,"humidity":69.0}
                else if (topic === 'c/5027241027/rumah/suhu') {
                    addLog(`üå°Ô∏è ${payload.temperature}¬∞C, üíß ${payload.humidity}%`, 'info');
                }
                
            } catch (e) {
                // Plain text message
                addLog(`   ${message}`, 'info');
            }
        }

        function updateESPStatus(online, reason = '') {
            espOnline = online;
            const statusEl = document.getElementById('espStatus');
            
            if (online) {
                statusEl.textContent = '‚úÖ ESP32 Online';
                statusEl.className = 'status-badge status-online';
                enableAllControls();
                addLog('ESP32 is online' + (reason ? ': ' + reason : ''), 'granted');
            } else {
                statusEl.textContent = '‚ö†Ô∏è ESP32 Offline';
                statusEl.className = 'status-badge status-offline';
                disableAllControls();
                addLog('ESP32 is offline' + (reason ? ': ' + reason : ''), 'denied');
            }
            
            document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString('id-ID');
        }

        function enableAllControls() {
            if (!mqttConnected) return;
            
            document.getElementById('ac1Power').disabled = false;
            document.getElementById('ac2Power').disabled = false;
            document.getElementById('doorBtn').disabled = false;
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('listenBtn').disabled = false;
            
            if (ac1.power) {
                document.getElementById('ac1TempDown').disabled = false;
                document.getElementById('ac1TempUp').disabled = false;
            }
            if (ac2.power) {
                document.getElementById('ac2TempDown').disabled = false;
                document.getElementById('ac2TempUp').disabled = false;
            }
        }

        function disableAllControls() {
            document.getElementById('ac1Power').disabled = true;
            document.getElementById('ac1TempDown').disabled = true;
            document.getElementById('ac1TempUp').disabled = true;
            document.getElementById('ac2Power').disabled = true;
            document.getElementById('ac2TempDown').disabled = true;
            document.getElementById('ac2TempUp').disabled = true;
            document.getElementById('doorBtn').disabled = true;
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('listenBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
        }

        function publishMQTT(topic, payload) {
            if (!mqttConnected) {
                addLog('‚ö†Ô∏è MQTT not connected! Please connect first.', 'denied');
                alert('MQTT not connected! Click "Connect to MQTT" button first.');
                return false;
            }

            if (!espOnline) {
                addLog('‚ö†Ô∏è ESP32 is offline! Command may not be received.', 'denied');
                const proceed = confirm('ESP32 appears offline. Send command anyway?');
                if (!proceed) return false;
            }

            const command = typeof payload === 'string' ? payload : JSON.stringify(payload);
            
            mqttClient.publish(topic, command, { qos: 1 }, (err) => {
                if (err) {
                    addLog(`‚ùå Failed to send: ${err.message}`, 'denied');
                } else {
                    commandCount++;
                    document.getElementById('cmdCount').textContent = commandCount;
                    addLog(`üì§ Sent to: ${topic.split('/').pop()}`, 'granted');
                    addLog(`   Payload: ${command}`, 'info');
                }
            });
            
            return true;
        }

        function updateACDisplay(unit) {
            const ac = unit === 1 ? ac1 : ac2;
            const statusEl = document.getElementById(`ac${unit}Status`);
            const tempEl = document.getElementById(`ac${unit}Temp`);
            const powerBtn = document.getElementById(`ac${unit}Power`);
            const tempDownBtn = document.getElementById(`ac${unit}TempDown`);
            const tempUpBtn = document.getElementById(`ac${unit}TempUp`);
            
            if (ac.power) {
                statusEl.textContent = 'ON';
                statusEl.className = 'ac-status';
                tempEl.className = 'ac-temp';
                tempEl.innerHTML = `${ac.temp}<span class="ac-temp-unit">¬∞C</span>`;
                powerBtn.className = 'control-btn btn-power on';
                tempDownBtn.disabled = ac.temp <= 16 || !espOnline;
                tempUpBtn.disabled = ac.temp >= 30 || !espOnline;
            } else {
                statusEl.textContent = 'OFF';
                statusEl.className = 'ac-status off';
                tempEl.className = 'ac-temp off';
                tempEl.innerHTML = `${ac.temp}<span class="ac-temp-unit">¬∞C</span>`;
                powerBtn.className = 'control-btn btn-power';
                tempDownBtn.disabled = true;
                tempUpBtn.disabled = true;
            }
        }

        function toggleAC(unit) {
            const ac = unit === 1 ? ac1 : ac2;
            ac.power = !ac.power;
            
            if (ac.power && ac.temp === 0) {
                ac.temp = 24;
            }
            
            const topic = document.getElementById(`ac${unit}Topic`).value;
            const command = {
                unit: unit,
                action: ac.power ? 'power_on' : 'power_off',
                temp: ac.temp
            };
            
            if (publishMQTT(topic, command)) {
                updateACDisplay(unit);
                addLog(`‚úÖ AC ${unit} ${ac.power ? 'Power ON' : 'Power OFF'} command sent`, ac.power ? 'granted' : 'info');
            }
        }

        function tempUp(unit) {
            const ac = unit === 1 ? ac1 : ac2;
            if (!ac.power || ac.temp >= 30) return;
            
            ac.temp++;
            
            const topic = document.getElementById(`ac${unit}Topic`).value;
            if (publishMQTT(topic, {
                unit: unit,
                action: 'temp_up',
                temp: ac.temp
            })) {
                updateACDisplay(unit);
                addLog(`‚úÖ AC ${unit} temperature ‚Üí ${ac.temp}¬∞C`, 'info');
            }
        }

        function tempDown(unit) {
            const ac = unit === 1 ? ac1 : ac2;
            if (!ac.power || ac.temp <= 16) return;
            
            ac.temp--;
            
            const topic = document.getElementById(`ac${unit}Topic`).value;
            if (publishMQTT(topic, {
                unit: unit,
                action: 'temp_down',
                temp: ac.temp
            })) {
                updateACDisplay(unit);
                addLog(`‚úÖ AC ${unit} temperature ‚Üí ${ac.temp}¬∞C`, 'info');
            }
        }

        function openDoor() {
            const doorIcon = document.getElementById('doorIcon');
            const doorStatus = document.getElementById('doorStatus');
            const doorBtn = document.getElementById('doorBtn');
            
            const topic = document.getElementById('doorTopic').value;
            if (publishMQTT(topic, { action: 'open' })) {
                doorIcon.textContent = 'üîì';
                doorStatus.textContent = 'UNLOCKED';
                doorBtn.disabled = true;
                
                addLog('‚úÖ Door OPEN command sent', 'granted');
                
                setTimeout(() => {
                    doorIcon.textContent = 'üîí';
                    doorStatus.textContent = 'LOCKED';
                    if (mqttConnected && espOnline) {
                        doorBtn.disabled = false;
                    }
                    
                    publishMQTT(topic, { action: 'close' });
                    addLog('‚úÖ Door CLOSE command sent (auto)', 'info');
                }, 3000);
            }
        }

        function recordPattern() {
            const topic = document.getElementById('knockTopic').value;
            if (publishMQTT(topic, 'RECORD_PATTERN')) {
                document.getElementById('modeStatus').textContent = 'üî¥ Recording...';
                document.getElementById('modeStatus').className = 'status-badge status-recording';
                addLog('‚úÖ Record pattern command sent', 'info');
            }
        }

        function startListening() {
            const topic = document.getElementById('knockTopic').value;
            if (publishMQTT(topic, 'START_LISTENING')) {
                document.getElementById('modeStatus').textContent = 'üëÇ Listening...';
                document.getElementById('modeStatus').className = 'status-badge status-listening';
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('listenBtn').disabled = true;
                addLog('‚úÖ Start listening command sent', 'info');
            }
        }

        function stopListening() {
            const topic = document.getElementById('knockTopic').value;
            if (publishMQTT(topic, 'STOP_LISTENING')) {
                document.getElementById('modeStatus').textContent = 'Ready';
                document.getElementById('modeStatus').className = 'status-badge status-offline';
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('listenBtn').disabled = false;
                addLog('‚úÖ Stop listening command sent', 'info');
            }
        }

        // Initialize displays
        updateACDisplay(1);
        updateACDisplay(2);
        addLog('üè† Smart Home Control System initialized', 'info');
        addLog('Click "Connect to MQTT" to start', 'info');
    </script>
</body>
</html>
